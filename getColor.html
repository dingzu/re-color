<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图像颜色分析</title>
    <script src=" https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js "></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 960px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f4f4f4;
        }

        .container {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .temperature-option {
            display: inline-block;
            margin-right: 10px;
            padding: 5px 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
        }

        .selected {
            background-color: #4CAF50;
            color: white;
        }

        .color-box {
            width: 50px;
            height: 50px;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
            border: 1px solid #ddd;
        }

        input[type="file"] {
            margin-bottom: 20px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>图像颜色分析</h1>
        <input type="file" id="imageInput" accept="image/*">
        <br><br>
        <img id="uploadedImage" style="max-width: 100%; display: none;">
        <br><br>
        <div id="colorInfo" style="display: none;">
            <h3>平均颜色</h3>
            <div class="color-box" id="averageColor"></div>
            <p id="averageColorHex"></p>
            <h3>颜色温度</h3>
            <div id="colorTemperature">
                <span class="temperature-option" data-temp="Cool">冷色</span>
                <span class="temperature-option" data-temp="Neutral">中性</span>
                <span class="temperature-option" data-temp="Warm">暖色</span>
            </div>
            <h3>最具特色的颜色</h3>
            <div class="color-box" id="distinctiveColor"></div>
            <p id="distinctiveColorHex"></p>
        </div>
        <table id="colorTable" style="display: none;">
            <tr>
                <th>颜色</th>
                <th>十六进制</th>
                <th>HSL</th>
                <th>百分比</th>
                <th>与平均值的距离</th>
            </tr>
        </table>
        <div id="distanceExplanation" style="display: none;">
            <h3>与平均值距离的解释：</h3>
            <p>0-50: 非常接近平均颜色</p>
            <p>51-100: 与平均颜色有中等程度的差异</p>
            <p>101-200: 与平均颜色有显著差异</p>
            <p>201+: 与平均颜色有极大差异</p>
        </div>
    </div>

    <script>
        const imageInput = document.getElementById('imageInput');
        const uploadedImage = document.getElementById('uploadedImage');
        const colorTable = document.getElementById('colorTable');
        const colorInfo = document.getElementById('colorInfo');
        const distanceExplanation = document.getElementById('distanceExplanation');
        const colorThief = new ColorThief();

        imageInput.addEventListener('change', function (e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function (event) {
                uploadedImage.src = event.target.result;
                uploadedImage.style.display = 'block';
                uploadedImage.onload = analyzeColors;
            }

            reader.readAsDataURL(file);
        });

        function analyzeColors() {
            const palette = colorThief.getPalette(uploadedImage, 30);
            let mergedPalette = mergeSimilarColors(palette);

            while (mergedPalette.length > 5) {
                mergedPalette = adaptiveMerge(mergedPalette);
            }

            const sortedPalette = mergedPalette.sort((a, b) => b.count - a.count);
            const totalCount = sortedPalette.reduce((sum, color) => sum + color.count, 0);
            const avgColor = calculateAverageColor(palette);
            const colorTemp = calculateColorTemperature(avgColor);

            displayMainColors(sortedPalette, totalCount, avgColor);
            displayAverageColor(avgColor);
            displayColorTemperature(colorTemp);
            displayDistinctiveColor(palette);

            colorTable.style.display = 'table';
            colorInfo.style.display = 'block';
            distanceExplanation.style.display = 'block';
        }

        function displayMainColors(sortedPalette, totalCount, avgColor) {
            colorTable.innerHTML = `
                <tr>
                    <th>颜色</th>
                    <th>十六进制</th>
                    <th>HSL</th>
                    <th>百分比</th>
                    <th>与平均值的距离</th>
                </tr>
            `;

            sortedPalette.forEach(color => {
                const percentage = ((color.count / totalCount) * 100).toFixed(2);
                const distance = Math.round(colorDistance(color.color, avgColor));
                const hsl = rgbToHsl(color.color[0], color.color[1], color.color[2]);
                const row = colorTable.insertRow();
                row.insertCell(0).innerHTML = `<div class="color-box" style="background-color: rgb(${color.color.join(',')})"></div>`;
                row.insertCell(1).textContent = rgbToHex(color.color);
                row.insertCell(2).textContent = `hsl(${Math.round(hsl[0])}, ${Math.round(hsl[1])}%, ${Math.round(hsl[2])}%)`;
                row.insertCell(3).textContent = `${percentage}%`;
                row.insertCell(4).textContent = distance;
            });
        }

        function displayAverageColor(avgColor) {
            document.getElementById('averageColor').style.backgroundColor = `rgb(${avgColor.join(',')})`;
            document.getElementById('averageColorHex').textContent = `十六进制: ${rgbToHex(avgColor)}`;
        }

        function displayColorTemperature(colorTemp) {
            const temperatureText = getTemperatureCategory(colorTemp);
            const options = document.querySelectorAll('.temperature-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.textContent === temperatureText) {
                    option.classList.add('selected');
                }
            });
            document.getElementById('colorTemperature').insertAdjacentHTML('beforeend',
                `<p>色温: ${Math.round(colorTemp)}K</p>`);
        }

        function displayDistinctiveColor(palette) {
            const distinctiveColor = findDistinctiveColor(palette);
            document.getElementById('distinctiveColor').style.backgroundColor = `rgb(${distinctiveColor.join(',')})`;
            document.getElementById('distinctiveColorHex').textContent = `十六进制: ${rgbToHex(distinctiveColor)}`;
        }

        function calculateAverageColor(palette) {
            const sum = palette.reduce((acc, color) => [acc[0] + color[0], acc[1] + color[1], acc[2] + color[2]], [0, 0, 0]);
            return sum.map(v => Math.round(v / palette.length));
        }

        function calculateColorTemperature(rgb) {
            const [r, g, b] = rgb;
            const X = (-0.14282 * r) + (1.54924 * g) + (-0.95641 * b);
            const Y = (-0.32466 * r) + (1.57837 * g) + (-0.73191 * b);
            const Z = (-0.68202 * r) + (0.77073 * g) + (0.56332 * b);

            const x = X / (X + Y + Z);
            const y = Y / (X + Y + Z);

            const n = (x - 0.3320) / (0.1858 - y);
            const corColorTemp = 449 * Math.pow(n, 3) + 3525 * Math.pow(n, 2) + 6823.3 * n + 5520.33;

            return corColorTemp;
        }

        function getTemperatureCategory(temp) {
            if (temp <= 3500) return "暖色";
            if (temp >= 5500) return "冷色";
            return "中性";
        }

        function findDistinctiveColor(palette) {
            const avgColor = calculateAverageColor(palette);
            return palette.reduce((distinctive, color) =>
                colorDistance(color, avgColor) > colorDistance(distinctive, avgColor) ? color : distinctive
            );
        }

        function mergeSimilarColors(palette, threshold = 30) {
            const mergedPalette = [];
            palette.forEach(color => {
                const similarColor = mergedPalette.find(c => colorDistance(c.color, color) < threshold);
                if (similarColor) {
                    similarColor.count += 1;
                    similarColor.color = averageColors(similarColor.color, color);
                } else {
                    mergedPalette.push({ color, count: 1 });
                }
            });
            return mergedPalette;
        }

        function adaptiveMerge(palette) {
            let minDistance = Infinity;
            let pair = null;

            for (let i = 0; i < palette.length; i++) {
                for (let j = i + 1; j < palette.length; j++) {
                    const distance = colorDistance(palette[i].color, palette[j].color);
                    if (distance < minDistance) {
                        minDistance = distance;
                        pair = [i, j];
                    }
                }
            }

            if (pair) {
                const [i, j] = pair;
                const newColor = averageColors(palette[i].color, palette[j].color);
                const newCount = palette[i].count + palette[j].count;
                palette[i] = { color: newColor, count: newCount };
                palette.splice(j, 1);
            }

            return palette;
        }

        function colorDistance(c1, c2) {
            return Math.sqrt(
                Math.pow(c1[0] - c2[0], 2) +
                Math.pow(c1[1] - c2[1], 2) +
                Math.pow(c1[2] - c2[2], 2)
            );
        }

        function averageColors(c1, c2) {
            return [
                Math.round((c1[0] + c2[0]) / 2),
                Math.round((c1[1] + c2[1]) / 2),
                Math.round((c1[2] + c2[2]) / 2)
            ];
        }

        function rgbToHex(rgb) {
            return "#" + rgb.map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? "0" + hex : hex;
            }).join('');
        }

        function rgbToHsl(r, g, b) {
            r /= 255, g /= 255, b /= 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h, s, l = (max + min) / 2;

            if (max === min) {
                h = s = 0; // achromatic
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }

            return [h * 360, s * 100, l * 100];
        }
    </script>
</body>

</html>